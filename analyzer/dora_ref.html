<!DOCTYPE html>
<html>
<head>
  <title>Django REST Framework Project Visualizer</title>
  <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
  <style>
    #cy {
      width: 100%;
      height: 95vh;
      border: 1px solid #ccc;
    }
    .legend {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 14px;
    }
    .legend div { margin-bottom: 5px; }
    .legend span {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 8px;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <div id="cy"></div>
  <div class="legend">
    <div><span style="background: yellow; border:1px solid #000;"></span> Folder</div>
    <div><span style="background: skyblue; border:1px solid #000;"></span> File</div>
    <div><span style="background: orange; clip-path: polygon(50% 0%, 93% 25%, 93% 75%, 50% 100%, 7% 75%, 7% 25%);"></span> Class</div>
    <div><span style="background: green; border-radius: 50%;"></span> Function</div>
    <div><span style="background: #888; width: 30px; height: 2px;"></span> Contains</div>
    <div><span style="background: red; width: 30px; height: 2px;"></span> Calls</div>
  </div>

  <script>
    const width = window.innerWidth;
    const height = window.innerHeight;

    const cy = cytoscape({
      container: document.getElementById('cy'),
      style: [
        { selector: 'node[type="folder"]', style: { 'shape': 'rectangle','background-color': 'yellow', 'label': 'data(label)','text-valign': 'center','text-halign': 'center','font-weight': 'bold','border-width': 2,'border-color': '#000','width': 150,'height': 80 }},
        { selector: 'node[type="file"]', style: { 'shape': 'rectangle','background-color': 'skyblue', 'label': 'data(label)','text-valign': 'center','text-halign': 'center','border-width': 1,'border-color': '#000','width': 120,'height': 60 }},
        { selector: 'node[type="class"]', style: { 'shape': 'hexagon','background-color': 'orange', 'label': 'data(label)','text-valign': 'center','text-halign': 'center','width': 100,'height': 60 }},
        { selector: 'node[type="function"]', style: { 'shape': 'ellipse','background-color': 'green','color': '#fff', 'label': 'data(label)','text-valign': 'center','text-halign': 'center','width': 60,'height': 40,'font-size': 10 }},
        { selector: 'edge[type="contains"]', style: { 'width': 2,'line-color': '#888','curve-style': 'bezier' }},
        { selector: 'edge[type="calls"]', style: { 'width': 2,'line-color': 'red','target-arrow-shape': 'triangle','target-arrow-color': 'red','curve-style': 'bezier' }},
        { selector: 'edge[label]', style: { 'label': 'data(label)','text-rotation': 'autorotate','text-margin-y': -10,'font-size': 10 }}
      ],
      elements: {
        nodes: [
          { data: { id: 'payments', label: 'Payments', type: 'folder' }, position: { x: 100, y: 100 } },
          { data: { id: 'carts', label: 'Carts', type: 'folder' }, position: { x: width - 200, y: 100 } },
          { data: { id: 'users', label: 'Users', type: 'folder' }, position: { x: 100, y: height - 200 } },
          { data: { id: 'orders', label: 'Orders', type: 'folder' }, position: { x: width - 200, y: height - 200 } },
          { data: { id: 'datapipelines', label: 'Datapipelines', type: 'folder' }, position: { x: width/2, y: 80 } },
          { data: { id: 'refunds', label: 'Refunds', type: 'folder' }, position: { x: width/2, y: height - 100 } },
          { data: { id: 'analytics', label: 'Analytics', type: 'folder' }, position: { x: width - 120, y: height/2 } }
        ]
      },
      layout: { name: 'preset' }
    });

    const expandedData = {
      payments: [
        { data: { id: 'payments_models', label: 'models.py', type: 'file' } },
        { data: { id: 'ThirdPartyAPI', label: 'ThirdPartyAPI', type: 'class' } },
        { data: { id: 'status', label: 'status()', type: 'function' } },
        { data: { id: 'pay', label: 'pay()', type: 'function' } },
        { data: { id: 'refund', label: 'refund()', type: 'function' } },
        { data: { id: 'PaymentGateway', label: 'PaymentGateway', type: 'class' } },
        { data: { id: 'get', label: 'get()', type: 'function' } },
        { data: { id: 'post', label: 'post()', type: 'function' } },
        { data: { id: 'put', label: 'put()', type: 'function' } },
        { data: { id: 'delete', label: 'delete()', type: 'function' } },
        { data: { id: 'pg_refund', label: 'refund()', type: 'function' } }
      ],
      orders: [
        { data: { id: 'orders_views', label: 'views.py', type: 'file' } },
        { data: { id: 'OrderService', label: 'OrderService', type: 'class' } },
        { data: { id: 'get_order', label: 'get_order()', type: 'function' } },
        { data: { id: 'place_order', label: 'place_order()', type: 'function' } }
      ],
      carts: [
        { data: { id: 'carts_models', label: 'models.py', type: 'file' } },
        { data: { id: 'CartService', label: 'CartService', type: 'class' } },
        { data: { id: 'get_cart_id', label: 'get_cart_id()', type: 'function' } }
      ]
    };

    const hierarchyRelationships = {
      payments: [
        { source: 'payments', target: 'payments_models', type: 'contains' },
        { source: 'payments_models', target: 'ThirdPartyAPI', type: 'contains' },
        { source: 'ThirdPartyAPI', target: 'status', type: 'contains' },
        { source: 'ThirdPartyAPI', target: 'pay', type: 'contains' },
        { source: 'ThirdPartyAPI', target: 'refund', type: 'contains' },
        { source: 'payments_models', target: 'PaymentGateway', type: 'contains' },
        { source: 'PaymentGateway', target: 'get', type: 'contains' },
        { source: 'PaymentGateway', target: 'post', type: 'contains' },
        { source: 'PaymentGateway', target: 'put', type: 'contains' },
        { source: 'PaymentGateway', target: 'delete', type: 'contains' },
        { source: 'PaymentGateway', target: 'pg_refund', type: 'contains' }
      ],
      orders: [
        { source: 'orders', target: 'orders_views', type: 'contains' },
        { source: 'orders_views', target: 'OrderService', type: 'contains' },
        { source: 'OrderService', target: 'get_order', type: 'contains' },
        { source: 'OrderService', target: 'place_order', type: 'contains' }
      ],
      carts: [
        { source: 'carts', target: 'carts_models', type: 'contains' },
        { source: 'carts_models', target: 'CartService', type: 'contains' },
        { source: 'CartService', target: 'get_cart_id', type: 'contains' }
      ]
    };

    const callRelationships = {
      payments: [
        { source: 'get', target: 'status', type: 'calls', label: 'uses' },
        { source: 'pg_refund', target: 'refund', type: 'calls', label: 'uses' },
        { source: 'pay', target: 'get_order', type: 'calls', label: 'fetches' }
      ],
      orders: [
        { source: 'place_order', target: 'get_cart_id', type: 'calls', label: 'uses' }
      ]
    };

    const expanded = {};

    cy.on('tap', 'node[type="folder"]', function(evt){
      const node = evt.target;
      const folderId = node.id();
      const basePos = node.position();

      if(expanded[folderId]){
        cy.remove(cy.nodes().filter(n => n.data('folder') === folderId));
        cy.remove(cy.edges().filter(e => e.data('folder') === folderId));
        expanded[folderId] = false;
        return;
      }

      const children = expandedData[folderId] || [];
      const newEles = [];

      // Add child nodes
      children.forEach((el, i) => {
        let posX = basePos.x + 200;
        let posY = basePos.y + i * 100;
        newEles.push({ data: { ...el.data, folder: folderId }, position: { x: posX, y: posY } });
      });

      // Add hierarchy edges
      if (hierarchyRelationships[folderId]) {
        hierarchyRelationships[folderId].forEach(rel => {
          newEles.push({
            data: { id: `${folderId}_h_${rel.source}_${rel.target}`, source: rel.source, target: rel.target, type: rel.type, folder: folderId }
          });
        });
      }

      // Add call edges (redirect to folder if target not expanded)
      if (callRelationships[folderId]) {
        callRelationships[folderId].forEach(rel => {
          let targetId = rel.target;
          if (cy.getElementById(targetId).empty()) {
            // fallback to folder node
            const folderForTarget = Object.keys(expandedData).find(fid =>
              expandedData[fid].some(n => n.data.id === rel.target)
            );
            if (folderForTarget) targetId = folderForTarget;
          }

          newEles.push({
            data: {
              id: `${folderId}_c_${rel.source}_${targetId}`,
              source: rel.source,
              target: targetId,
              type: rel.type,
              label: rel.label,
              folder: folderId
            }
          });
        });
      }

      cy.add(newEles);
      expanded[folderId] = true;
    });
  </script>
</body>
</html>
